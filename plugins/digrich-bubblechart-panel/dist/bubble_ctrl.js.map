{"version":3,"sources":["../src/bubble_ctrl.js"],"names":["MetricsPanelCtrl","d3","_","$","TimeSeries","config","kbn","panelDefaults","mode","bgColor","valueName","nullPointMode","decimal","format","colorScheme","groupDepthColors","thresholds","thresholdColors","gradientThresholds","gradientColors","groupSeperator","displayLabel","height","BubbleChartCtrl","$scope","$injector","defaultsDeep","panel","containerDivId","id","panelContainer","svgContainer","svgBubbleId","events","on","onRender","bind","onInitEditMode","onDataReceived","onDataError","dataList","series","map","seriesHandler","render","seriesData","datapoints","alias","target","flotpairs","getFlotPairs","serie","i","name","aliases","split","size","valueFormater","stats","tree","parsedSeries","parseSeries","forEach","createRecurseTree","record","length","group","find","children","r","undefined","push","shift","newKey","newId","angular","element","isEmptyObject","_id","child","key","recurseTree","container","remove","panelTitleOffset","title","panelHeight","getPanelHeight","panelWidth","getPanelWidthBySpan","Math","min","svg","select","append","attr","opt","valueFormatFunc","valueFormats","bootData","user","lightTheme","bubble","bubbleChart","data","renderData","addEditorTab","unitFormats","getUnitFormats","subItem","value","$timeout","cancel","nextTickPromise","tmp","row","isString","parseInt","replace","viewPortWidth","max","document","documentElement","clientWidth","window","innerWidth","pixelsPerSpan","trueWidth","round","span","scope","elem","attrs","ctrl","gaugeByClass","childNodes","setContainer","parseSeriesToJSON","addBubbleChart","renderingCompleted","templateUrl"],"mappings":"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","file":"bubble_ctrl.js","sourcesContent":["import { MetricsPanelCtrl } from 'app/plugins/sdk';\nimport * as d3 from './external/d3.v3.min';\nimport _ from 'lodash';\nimport $ from 'jquery';\nimport TimeSeries from 'app/core/time_series';\nimport './external/d3.tip.v0.6.3';\nimport './css/bubble-panel.css!';\nimport './external/bubble';\nimport config from 'app/core/config';\nimport kbn from 'app/core/utils/kbn';\n\nconst panelDefaults = {\n    mode: 'time',\n    bgColor: null,\n    valueName: 'current',\n    nullPointMode: 'connected',\n    decimal: 2,\n    format: 'short',\n    colorScheme: 'Group',\n    groupDepthColors: [\"hsl(152,80%,80%)\", \"hsl(228,30%,40%)\"],\n    thresholds: \"50,80\",\n    thresholdColors: [\"green\", \"yellow\", \"red\"],\n    gradientThresholds: \"50,80\",\n    gradientColors: ['red', 'green'],\n    groupSeperator: ',',\n    displayLabel: true,\n    height: 400\n};\n\nexport class BubbleChartCtrl extends MetricsPanelCtrl {\n\n    constructor($scope, $injector) {\n        super($scope, $injector);\n        _.defaultsDeep(this.panel, panelDefaults);\n\n        this.containerDivId = 'container_' + this.panel.id;\n        this.panelContainer = null;\n        this.panel.svgContainer = null;\n        this.panel.svgBubbleId = 'svg_' + this.panel.id;\n\n        this.events.on('render', this.onRender.bind(this));\n        this.events.on('init-edit-mode', this.onInitEditMode.bind(this));\n        this.events.on('data-received', this.onDataReceived.bind(this));\n        this.events.on('data-error', this.onDataError.bind(this));\n        this.events.on('data-snapshot-load', this.onDataReceived.bind(this));\n    }\n\n    onDataReceived(dataList) {\n        this.series = dataList.map(this.seriesHandler.bind(this));\n        this.render();\n    }\n\n    seriesHandler(seriesData) {\n        var series = new TimeSeries({\n            datapoints: seriesData.datapoints,\n            alias: seriesData.target\n        });\n\n        series.flotpairs = series.getFlotPairs(this.panel.nullPointMode);\n        return series;\n    }\n\n    parseSeries(series) {\n        return _.map(this.series, (serie, i) => {\n            return {\n                name: serie.alias,\n                aliases: serie.alias.split(this.panel.groupSeperator),\n                size: serie.valueFormater(serie.stats[this.panel.valueName], this.panel.decimal)\n            };\n        });\n    }\n\n    parseSeriesToJSON() {\n        var tree = { \"name\": \"grid\", \"children\": [] };\n        this.parsedSeries = this.parseSeries(this.series);\n        _.forEach(this.parsedSeries, record => {\n            this.createRecurseTree(tree, record.aliases, record);\n        });\n        return tree;\n    }\n\n    createRecurseTree(tree, aliases, record) {\n        if (aliases.length === 0)\n            return;\n        var alias = aliases[0];\n        var group = _.find(tree.children, function(r) {\n            return r.name == alias;\n        });\n        if (group === undefined) {\n            if (aliases.length == 1) {\n                group = { \"name\": alias };\n            } else {\n                group = { \"name\": alias, \"children\": [] };\n            }\n\n            tree.children.push(group);\n        }\n        if (aliases.length == 1) {\n            group.size = record.size;\n        }\n        aliases.shift();\n        this.createRecurseTree(group, aliases, record);\n    }\n\n    recurseTree(tree, newKey, newId) {\n        if (angular.element.isEmptyObject(tree)) {\n            tree[newKey] = { _id: newId };\n            return;\n        }\n\n        var child = null; // find current tree's child\n        for (var key in tree) {\n            if (key != '_id') {\n                child = tree[key]; // found a child\n                break;\n            }\n        }\n        if (child) { // recursively process on child\n            recurseTree(child, newKey, newId);\n        } else { // no child, so just fill the tree\n            tree[newKey] = { _id: newId };\n        }\n    }\n\n    onDataError() {\n        this.series = [];\n        this.render();\n    }\n\n    /**\n     * [setContainer description]\n     * @param {[type]} container [description]\n     */\n    setContainer(container) {\n        this.panelContainer = container;\n        this.panel.svgContainer = container;\n    }\n\n    onRender() {\n        //this.data = json_data;\n    }\n\n    addBubbleChart() {\n        if ($('#' + this.panel.svgBubbleId).length) {\n            $('#' + this.panel.svgBubbleId).remove();\n        }\n\n        var panelTitleOffset = 0;\n        if (this.panel.title !== \"\") {\n            panelTitleOffset = 25;\n        }\n        this.panelHeight = this.getPanelHeight() - panelTitleOffset;\n        this.panelWidth = this.getPanelWidthBySpan();\n\n        this.panelHeight = this.panelWidth = Math.min(this.panelHeight, this.panelWidth);\n        var svg = d3.select(this.panel.svgContainer)\n            .append(\"svg\")\n            .attr(\"width\", this.panelWidth)\n            .attr(\"height\", this.panelHeight)\n            .attr(\"viewBox\", '0,0,' + this.panelHeight + ',' + this.panelWidth)\n            .attr(\"id\", this.panel.svgBubbleId);\n\n        var opt = {\n            colorScheme: this.panel.colorScheme,\n            groupDepthColors: this.panel.groupDepthColors,\n            thresholds: this.panel.thresholds,\n            thresholdColors: this.panel.thresholdColors,\n            gradientThresholds: this.panel.gradientThresholds,\n            gradientColors: this.panel.gradientColors,\n            displayLabel: this.panel.displayLabel,\n            valueFormatFunc: kbn.valueFormats[this.panel.format],\n            decimal: this.panelContainer.decimal,\n            bgColor: config.bootData.user.lightTheme ?\n                'rgb(230,230,230)' : 'rgb(38,38,38)'\n        };\n        this.bubble = new bubbleChart(svg, opt);\n        if (this.data)\n            this.bubble.renderData(this.data);\n    }\n\n    onInitEditMode() {\n        this.addEditorTab('Options', 'public/plugins/digrich-bubblechart-panel/editor.html', 2);\n        this.unitFormats = kbn.getUnitFormats();\n    }\n\n    setUnitFormat(subItem) {\n        this.panel.format = subItem.value;\n        this.render();\n    }\n\n    onPanelTeardown() {\n        this.$timeout.cancel(this.nextTickPromise);\n    }\n\n    invertColorOrder() {\n        var tmp = this.panel.thresholdColors[0];\n        this.panel.thresholdColors[0] = this.panel.thresholdColors[2];\n        this.panel.thresholdColors[2] = tmp;\n        this.render();\n    }\n\n    getPanelHeight() {\n        // panel can have a fixed height via options\n        var height = this.panel.height || this.row.height || 250;\n        if (_.isString(height)) {\n            height = parseInt(height.replace('px', ''), 10);\n        }\n        return height;\n    }\n\n    // determine the width of a panel by the span and viewport\n    getPanelWidthBySpan() {\n        var viewPortWidth = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);\n        // get the pixels of a span\n        var pixelsPerSpan = viewPortWidth / 12;\n        // multiply num spans by pixelsPerSpan\n        var trueWidth = Math.round(this.panel.span * pixelsPerSpan);\n        return trueWidth;\n    }\n\n    link(scope, elem, attrs, ctrl) {\n        var gaugeByClass = elem.find('div#bubble-container');\n        gaugeByClass.append('<div id=\"' + ctrl.containerDivId + '\"></div>');\n\n        var container = gaugeByClass[0].childNodes[1];\n        ctrl.setContainer(container);\n\n        function render() {\n            if (!ctrl.series) { return; }\n\n            ctrl.data = ctrl.parseSeriesToJSON();\n            ctrl.addBubbleChart();\n        }\n        this.events.on('render', () => {\n            render();\n            ctrl.renderingCompleted();\n        });\n    }\n}\n\nBubbleChartCtrl.templateUrl = 'module.html';"]}